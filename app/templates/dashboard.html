{% extends "base.html" %}

{% block content %}

<div class="max-w-5xl mx-auto mt-10 px-4">

    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">
                Welcome, {{ current_user.username }} ðŸ‘‹
            </h1>
            <p class="text-gray-500 mt-1">
                Manage your tasks efficiently and stay productive.
            </p>
        </div>
       
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

        <div class="bg-white p-6 rounded-2xl shadow">
            <p class="text-gray-500 text-sm">Total Tasks</p>
            <h2 id ="total-count" class="text-3xl font-bold mt-2">{{ tasks|length }}</h2>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow">
            <p class="text-gray-500 text-sm">Completed</p>
            <h2 id = "completed-count" class="text-3xl font-bold mt-2">
                {{ tasks|selectattr('completed')|list|length }}
            </h2>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow">
            <p class="text-gray-500 text-sm">Pending</p>
            <h2 id = "pending-count" class="text-3xl font-bold mt-2">
                {{ tasks|rejectattr('completed')|list|length }}
            </h2>
        </div>
    </div>


    <!-- Add Task Card -->
    <div class="bg-white p-6 rounded-2xl shadow mb-8">
        <h2 class="text-xl font-semibold mb-4">Add New Task</h2>

        <form method="POST" action="{{ url_for('main.add_task') }}" class="flex gap-4">
            <input type="text"
                   name="title"
                   placeholder="Enter task title..."
                   required
                   class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">

            <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow">
                Add
            </button>
        </form>
    </div>

    <!-- Task List -->
    <div class="bg-white p-6 rounded-2xl shadow">
        <h2 class="text-xl font-semibold mb-6">Your Tasks</h2>

        {% if tasks %}
            <div class="space-y-4">
                {% for task in tasks %}
                <div class="flex justify-between items-center border-b pb-3">

                    <div>
                        <h3 id = "task-title-{{task.id}}" class="font-medium text-lg
                            {% if task.completed %}
                                line-through text-gray-400
                            {% else %}
                                text-gray-800
                            {% endif %}">
                            {{ task.title }}
                        </h3>

                       <button 
                            onclick="toggleTask({{task.id}}, this)"
                            class="px-3 py-1 rounded-lg text-sm text-white
                            {% if task.completed %}
                                bg-yellow-500
                            {% else %}
                                bg-green-500
                            {% endif %}">
                            
                            {% if task.completed %}
                                Undo
                            {% else %}
                                Complete
                            {% endif %}
                        </button>

                        
                    </div>

                    <div class="flex gap-3">

                        <form method="POST" action="{{ url_for('main.delete_task', task_id=task.id) }}">
                            <button type="submit"
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm"
                                onsubmit="return confirm('Are you sure you want to delete this task?');">
                                Delete
                            </button>
                        </form>

                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center text-gray-500 py-10">
                No tasks yet. Start by adding one above ðŸš€
            </div>
        {% endif %}
    </div>


{% endblock %}

{% block scripts %}
<script>
function toggleTask(taskId, button) {
    fetch(`/complete/${taskId}`, {
        method: "POST",
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(response => response.json())
    .then(data => {

        if (data.success) {
            const title = document.getElementById(`task-title-${taskId}`);

            if (data.completed) {
                button.innerText = "Undo";
                button.classList.remove("bg-green-500");
                button.classList.add("bg-yellow-500");
                title.classList.add("line-through", "text-gray-400");
            } else {
                button.innerText = "Complete";
                button.classList.remove("bg-yellow-500");
                button.classList.add("bg-green-500");
                title.classList.remove("line-through", "text-gray-400");
            }
        }

        const totalEl = document.getElementById("total-count");
const completedEl = document.getElementById("completed-count");
const pendingEl = document.getElementById("pending-count");

let total = parseInt(totalEl.innerText);
let completed = parseInt(completedEl.innerText);
let pending = parseInt(pendingEl.innerText);

if (data.completed) {
    completed++;
    pending--;
} else {
    completed--;
    pending++;
}

completedEl.innerText = completed;
pendingEl.innerText = pending;
    });
}
</script>
{% endblock %}
